<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Elsa App</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #000; color: gold; margin: 0; }
    .container { padding: 1rem; }
    input, button, select { display: block; width: 100%; margin: 0.5rem 0; padding: 0.5rem; border: 1px solid gold; background: #111; color: gold; border-radius: 5px; }
    .notice { color: green; font-weight: bold; text-align: center; }
    nav { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: space-around; border-top: 1px solid gold; }
    nav button { background: transparent; border: none; color: gold; padding: 1rem; }
    .tab { display: none; padding-bottom: 60px; }
    .active { display: block; }
    canvas { max-width: 100%; }
  </style>
</head>
<body>
  <div class="container">
    <div id="authTab" class="tab active">
      <h1>Register</h1>
      <input type="email" id="regEmail" placeholder="Email">
      <input type="password" id="regPassword" placeholder="Password">
      <button onclick="registerUser()">Register</button>

      <h1>Login</h1>
      <input type="email" id="logEmail" placeholder="Email">
      <input type="password" id="logPassword" placeholder="Password">
      <button onclick="loginUser()">Login</button>
      <p class="notice" id="notice"></p>
    </div>

    <div id="profileTab" class="tab">
      <h2>Profile</h2>
      <p id="profileEmail"></p>
      <p id="profileUsername"></p>
      <p id="profileWallet"></p>
      <p id="profileRefCode"></p>
      <p id="profileVerified"></p>
      <input type="text" id="userCountry" placeholder="Country">
      <input type="text" id="userPhoto" placeholder="Photo URL">
      <button onclick="verifyUser()">Verify Account ($1)</button>
    </div>

    <div id="marketTab" class="tab">
      <h2>Live Market Chart (Candlestick)</h2>
      <canvas id="liveChart" height="150"></canvas>
      <button style="background: green;" onclick="buyCommodity()">Buy ($2)</button>
      <button style="background: red;" onclick="sellCommodity()">Sell ($2.60)</button>
    </div>

    <div id="historyTab" class="tab">
      <h2>Transaction History</h2>
      <ul id="historyList"></ul>
    </div>
  </div>

  <nav>
    <button onclick="switchTab('authTab')">Login</button>
    <button onclick="switchTab('profileTab')">Profile</button>
    <button onclick="switchTab('marketTab')">Market</button>
    <button onclick="switchTab('historyTab')">History</button>
  </nav>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC8kLmGOyODdlrvHId2Nz3opdpT0tvD5mk",
  authDomain: "elsa-ab176.firebaseapp.com",
  projectId: "elsa-ab176",
  storageBucket: "elsa-ab176.firebasestorage.app",
  messagingSenderId: "850786583459",
  appId: "1:850786583459:android:5710287d8738f48e8e1016"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const urlParams = new URLSearchParams(window.location.search);
const ref = urlParams.get('ref');
if (ref) localStorage.setItem("referredBy", ref);

function switchTab(id) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function registerUser() {
  const email = document.getElementById("regEmail").value;
  const password = document.getElementById("regPassword").value;
  auth.createUserWithEmailAndPassword(email, password)
    .then((userCredential) => {
      const user = userCredential.user;
      const defaultWallet = email === 'eluxxes@gmail.com' ? 10 : 0;
      const referralCode = 'ELX-' + Math.floor(Math.random() * 100000);
      const referredBy = localStorage.getItem("referredBy") || "";
      const userData = {
        uid: user.uid,
        email: user.email,
        username: email.split('@')[0],
        wallet: defaultWallet,
        verified: false,
        verificationPaid: false,
        referrals: 0,
        referralCode: referralCode,
        referredBy: referredBy,
        photoURL: '',
        country: '',
        registrationTime: firebase.firestore.FieldValue.serverTimestamp(),
        transactions: []
      };
      db.collection('users').doc(user.uid).set(userData);
      alert("Registered successfully!");
    }).catch(e => alert(e.message));
}

function loginUser() {
  const email = document.getElementById("logEmail").value;
  const password = document.getElementById("logPassword").value;
  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      alert("Logged in!");
      loadProfile();
      switchTab('profileTab');
      fetchChartData();
    }).catch(e => alert(e.message));
}

function loadProfile() {
  const user = auth.currentUser;
  if (!user) return;
  db.collection('users').doc(user.uid).get().then(doc => {
    const data = doc.data();
    document.getElementById('profileEmail').innerText = "Email: " + data.email;
    document.getElementById('profileUsername').innerText = "Username: " + data.username;
    document.getElementById('profileWallet').innerText = "Wallet: $" + data.wallet;
    document.getElementById('profileRefCode').innerText = "Referral Code: " + data.referralCode;
    document.getElementById('profileVerified').innerText = data.verified ? "✅ Verified" : "❌ Not Verified";
  });
}

function verifyUser() {
  const user = auth.currentUser;
  const country = document.getElementById('userCountry').value;
  const photo = document.getElementById('userPhoto').value;
  if (!country || !photo) return alert("Fill country and photo link.");
  alert("Redirecting to Paystack...");
  db.collection('users').doc(user.uid).update({ verified: true, verificationPaid: true, country, photoURL: photo });
  alert("You are now verified!");
  loadProfile();
}

function buyCommodity() {
  const user = auth.currentUser;
  db.collection('users').doc(user.uid).update({
    wallet: firebase.firestore.FieldValue.increment(-2),
    transactions: firebase.firestore.FieldValue.arrayUnion({ type: 'buy', amount: 2, time: Date.now() })
  });
  alert("Bought commodity for $2");
}

function sellCommodity() {
  const user = auth.currentUser;
  db.collection('users').doc(user.uid).get().then(doc => {
    if (!doc.data().verified) return alert("Only verified users can sell.");
    db.collection('users').doc(user.uid).update({
      wallet: firebase.firestore.FieldValue.increment(2.45),
      transactions: firebase.firestore.FieldValue.arrayUnion({ type: 'sell', amount: 2.6, fee: 0.15, time: Date.now() })
    });
    alert("Sold for $2.60 (0.15 fee deducted)");
  });
}

// Live Chart Loader
function fetchChartData() {
  const ctx = document.getElementById('liveChart').getContext('2d');
  db.collection("chartData").orderBy("timestamp", "desc").limit(20).onSnapshot(snapshot => {
    const candles = snapshot.docs.map(doc => doc.data()).reverse();
    new Chart(ctx, {
      type: 'candlestick',
      data: {
        datasets: [{
          label: 'Live Commodity Price',
          data: candles.map(d => ({ x: new Date(d.timestamp), o: d.open, h: d.high, l: d.low, c: d.close }))
        }]
      },
      options: { responsive: true }
    });
  });
}
</script>
</body>
</html>
