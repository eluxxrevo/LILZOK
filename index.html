<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Elsa App - Commodities</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: linear-gradient(135deg, #000000, #4b3621);
      color: gold;
    }
    .section, .auth-page {
      display: none;
      padding: 20px;
    }
    .active {
      display: block;
    }
    .tab-bar, .commodity-bar {
      display: flex;
      justify-content: space-around;
      padding: 10px;
      background: #222;
    }
    button {
      background: gold;
      color: black;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    input, label {
      display: block;
      margin-top: 10px;
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: none;
    }
    .notif {
      background: #333;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
    }
    #chart {
      height: 300px;
    }
    h2, h3 {
      color: gold;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>

<div class="notif" id="notif"></div>

<!-- Auth Pages -->
<div id="loginPage" class="auth-page active">
  <h2>Login</h2>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Password">
  <button onclick="login()">Login</button>
  <p>Don't have an account? <a href="#" onclick="showRegister()">Register</a></p>
</div>

<div id="registerPage" class="auth-page">
  <h2>Register</h2>
  <input type="email" id="regEmail" placeholder="Email">
  <input type="password" id="regPassword" placeholder="Password">
  <button onclick="register()">Register</button>
  <p>Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
</div>

<!-- Main App Sections -->
<div id="market" class="section">
  <h2>Market</h2>
  <div class="commodity-bar" id="commodityTabs"></div>
  <h3 id="currentCommodity">Gold</h3>
  <div id="chart"></div>
  <p>Current Price: $<span id="priceDisplay">2.00</span></p>
  <button onclick="buyCommodity()">Buy</button>
  <button onclick="sellCommodity()">Sell</button>
</div>

<div id="wallet" class="section">
  <h2>Wallet</h2>
  <p>Balance: $<span id="userBalance"></span></p>
  <button onclick="depositFunds()">Deposit ₦1000</button>
  <button onclick="withdrawFunds()">Withdraw</button>
</div>

<div id="profile" class="section">
  <h2>Profile</h2>
  <p>Email: <span id="userEmail"></span></p>
  <p>Status: <span id="verifyStatus"></span></p>
  <p>Referrals: <span id="referralCount">0</span> / 8</p>
  <p>Referral Code: <span id="userReferralCode"></span></p>
  <p>Referral Link: <code id="refLink"></code></p>
  <button onclick="verifyUser()">Verify ($1)</button>
</div>

<div id="leaderboard" class="section">
  <h2>Top Referrers</h2>
  <ul id="leaderList"></ul>
</div>

<!-- Tab Bar -->
<div class="tab-bar">
  <button onclick="showSection('market')">Market</button>
  <button onclick="showSection('wallet')">Wallet</button>
  <button onclick="showSection('profile')">Profile</button>
  <button onclick="showSection('leaderboard')">Leaderboard</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC8kLmGOyODdlrvHId2Nz3opdpT0tvD5mk",
  authDomain: "elsa-ab176.firebaseapp.com",
  projectId: "elsa-ab176",
  storageBucket: "elsa-ab176.appspot.com",
  messagingSenderId: "850786583459",
  appId: "1:850786583459:android:5710287d8738f48e8e1016"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const commodities = ["Gold", "Diamond", "SOL"];
let currentCommodity = "Gold";
let chart;
let chartSeries;
let userId = null;
let refBy = new URLSearchParams(window.location.search).get('ref');

function showNotification(msg) {
  const n = document.getElementById("notif");
  n.innerText = msg;
  n.style.display = "block";
  setTimeout(() => n.style.display = "none", 3000);
}

function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function showLogin() {
  document.querySelectorAll('.auth-page').forEach(p => p.classList.remove('active'));
  document.getElementById('loginPage').classList.add('active');
}

function showRegister() {
  document.querySelectorAll('.auth-page').forEach(p => p.classList.remove('active'));
  document.getElementById('registerPage').classList.add('active');
}
  function login() {
  const email = document.getElementById("loginEmail").value;
  const pass = document.getElementById("loginPassword").value;
  auth.signInWithEmailAndPassword(email, pass)
    .then(user => {
      showSection('market');
      initApp(user.user);
    })
    .catch(err => showNotification(err.message));
}

function register() {
  const email = document.getElementById("regEmail").value;
  const pass = document.getElementById("regPassword").value;
  auth.createUserWithEmailAndPassword(email, pass)
    .then(res => {
      const user = res.user;
      db.collection("users").doc(user.uid).set({
        email,
        balance: email === "eluxxes@gmail.com" ? 10 : 0,
        verified: false,
        referrals: 0,
        refcode: user.uid.slice(0, 6),
        referredBy: refBy || null
      });
      showSection('market');
      initApp(user);
    })
    .catch(err => showNotification(err.message));
}

function initApp(user) {
  userId = user.uid;
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("registerPage").style.display = "none";
  db.collection("users").doc(userId).onSnapshot(doc => {
    const data = doc.data();
    document.getElementById("userBalance").innerText = data.balance.toFixed(2);
    document.getElementById("userEmail").innerText = data.email;
    document.getElementById("verifyStatus").innerText = data.verified ? "Verified ✅" : "Not Verified ❌";
    document.getElementById("referralCount").innerText = data.referrals;
    document.getElementById("userReferralCode").innerText = data.refcode;
    document.getElementById("refLink").innerText = location.origin + "?ref=" + data.refcode;
  });
  renderChart(currentCommodity);
  renderLeaderboard();
}

function depositFunds() {
  window.open("https://paystack.com/buy/lilzok-vjmgrv", "_blank");
}

function withdrawFunds() {
  showNotification("Withdrawals processed manually. Minimum $4.");
}

function buyCommodity() {
  db.collection("users").doc(userId).get().then(doc => {
    const data = doc.data();
    if (data.balance >= 2) {
      db.collection("users").doc(userId).update({
        balance: data.balance - 2
      });
      showNotification("Purchase successful!");
    } else {
      showNotification("Insufficient balance.");
    }
  });
}

function sellCommodity() {
  db.collection("users").doc(userId).get().then(doc => {
    const data = doc.data();
    if (!data.verified) return showNotification("Only verified users can sell.");
    db.collection("users").doc(userId).update({
      balance: data.balance + 2.45 // $2.60 minus $0.15 maintenance
    });
    showNotification("Sold for $2.45 after fee.");
  });
}

function verifyUser() {
  window.open("https://paystack.com/buy/lilzok-vjmgrv", "_blank");
  db.collection("users").doc(userId).update({ verified: true });
}

function renderChart(symbol) {
  document.getElementById("currentCommodity").innerText = symbol;
  if (chart) chart.remove();
  chart = LightweightCharts.createChart(document.getElementById("chart"), {
    width: 400,
    height: 300,
    layout: { background: { color: "#000" }, textColor: "gold" }
  });
  chartSeries = chart.addCandlestickSeries();
  db.collection("chart").doc(symbol).onSnapshot(doc => {
    const data = doc.data();
    if (data && data.candles) {
      chartSeries.setData(data.candles);
      const last = data.candles[data.candles.length - 1];
      document.getElementById("priceDisplay").innerText = last.close.toFixed(2);
    }
  });
}

function renderLeaderboard() {
  db.collection("users").orderBy("referrals", "desc").limit(10).get().then(snapshot => {
    const ul = document.getElementById("leaderList");
    ul.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const li = document.createElement("li");
      li.innerText = `${data.email} - ${data.referrals} referrals`;
      ul.appendChild(li);
    });
  });
}

window.onload = () => {
  auth.onAuthStateChanged(user => {
    if (user) {
      showSection('market');
      initApp(user);
    }
  });
  const tabBar = document.getElementById("commodityTabs");
  commodities.forEach(c => {
    const btn = document.createElement("button");
    btn.innerText = c;
    btn.onclick = () => {
      currentCommodity = c;
      renderChart(c);
    };
    tabBar.appendChild(btn);
  });
};
</script>
</body>
</html>
